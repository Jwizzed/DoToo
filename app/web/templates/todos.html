{% extends "base.html" %}

{% block title %}My Todos{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
         <h1>My Todo List</h1>
         {# Add button? Or keep add form below #}
    </div>


    {# --- Flash Messages --- #}
    {% if error %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        {{ error }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    {% if message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
    {# -------------------- #}


    {# --- Add New Todo Form --- #}
    <div class="card mb-4">
        <div class="card-header">Add New Todo</div>
        <div class="card-body">
            <form action="{{ url_for('web_add_todo') }}" method="post" enctype="multipart/form-data">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="title" class="form-label">Title</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                     <div class="col-md-6 mb-3">
                        <label for="priority" class="form-label">Priority</label>
                        <select class="form-select" id="priority" name="priority" required>
                             {# Default to Medium #}
                             {% for value, display in priority_options.items() %}
                             <option value="{{ value }}" {% if value == 2 %}selected{% endif %}>{{ display }}</option>
                             {% endfor %}
                         </select>
                    </div>
                </div>
                 <div class="mb-3">
                    <label for="description" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="2"></textarea>
                </div>
                 <div class="row">
                     <div class="col-md-6 mb-3">
                         <label for="due_date" class="form-label">Due Date (Optional)</label>
                         <input type="date" class="form-control" id="due_date" name="due_date">
                     </div>
                    <div class="col-md-6 mb-3">
                        <label for="photo" class="form-label">Upload Photo (Optional)</label>
                        <input class="form-control" type="file" id="photo" name="photo" accept="image/*">
                    </div>
                 </div>
                <button type="submit" class="btn btn-primary">Add Todo</button>
            </form>
        </div>
    </div>
    {# ----------------------- #}


    {# --- Filter/Sort/Search Form --- #}
    <div class="card mb-4">
         <div class="card-header">Filter & Sort Todos</div>
         <div class="card-body">
            <form method="get" action="{{ url_for('web_read_todos') }}">
                 <div class="row g-3 align-items-end">
                     <div class="col-md-3">
                         <label for="filter_status" class="form-label">Status</label>
                         <select id="filter_status" name="status" class="form-select">
                             <option value="">All Statuses</option>
                             {% for status_opt in status_options %}
                             <option value="{{ status_opt }}" {% if filters.status == status_opt %}selected{% endif %}>{{ status_opt }}</option>
                             {% endfor %}
                         </select>
                     </div>
                      <div class="col-md-3">
                         <label for="filter_priority" class="form-label">Priority</label>
                         <select id="filter_priority" name="priority" class="form-select">
                             <option value="">All Priorities</option>
                             {% for value, display in priority_options.items() %}
                             {# Compare value (int) with filters.priority (str from query param) #}
                             <option value="{{ value }}" {% if filters.priority == value|string %}selected{% endif %}>{{ display }}</option>
                             {% endfor %}
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="sort_by" class="form-label">Sort By</label>
                         <select id="sort_by" name="sort" class="form-select">
                              {% for value, display in sort_options.items() %}
                              <option value="{{ value }}" {% if filters.sort == value %}selected{% endif %}>{{ display }}</option>
                              {% endfor %}
                         </select>
                     </div>
                     <div class="col-md-3">
                         <label for="search_term" class="form-label">Search</label>
                         <input type="search" id="search_term" name="search" class="form-control" placeholder="Title/Description..." value="{{ filters.search or '' }}">
                     </div>
                     <div class="col-12 mt-3">
                         <button type="submit" class="btn btn-info">Apply Filters</button>
                         <a href="{{ url_for('web_read_todos') }}" class="btn btn-outline-secondary">Clear Filters</a>
                     </div>
                 </div>
             </form>
        </div>
    </div>
    {# --------------------------- #}


    {# --- Current Todos List --- #}
    <h2>Current Todos</h2>
    {% if todos %}
    <ul class="list-group">
        {% for todo in todos %}
        {# Determine background color based on status #}
        {% set item_class = '' %}
        {% if todo.status == 'Done' %}
             {% set item_class = 'list-group-item-light text-muted' %} {# Muted/light for Done #}
        {% elif todo.status == 'In Progress' %}
             {% set item_class = 'list-group-item-warning' %}
        {% endif %}
        {# Add urgency based on due date and priority (border color) #}
        {% set border_class = '' %}
        {# Check if today_date exists before comparing #}
        {% if today_date is defined and todo.due_date and todo.due_date < today_date and todo.status != 'Done' %} {# Overdue #}
              {% set border_class = 'border-danger border-2' %}
        {% elif todo.priority == 1 and todo.status != 'Done' %} {# High Prio #}
             {% set border_class = 'border-danger' %}
        {% elif todo.priority == 3 and todo.status != 'Done' %} {# Low Prio #}
             {% set border_class = 'border-info' %}
        {% endif %}


        <li class="list-group-item d-flex flex-column flex-md-row justify-content-between align-items-md-center {{ item_class }} {{ border_class }} mb-2">
             {# --- Todo Details --- #}
            <div class="flex-grow-1 me-3 mb-2 mb-md-0">
                <h5 class="mb-1">
                     {% if todo.status == 'Done' %}<s>{{ todo.title }}</s>{% else %}{{ todo.title }}{% endif %}
                     {# Badges for Priority and Status #}
                     <span class="badge rounded-pill
                         {% if todo.priority == 1 %} bg-danger
                         {% elif todo.priority == 2 %} bg-warning text-dark
                         {% else %} bg-info text-dark
                         {% endif %}
                         ms-2">{{ todo.priority_str }}</span>
                     {% if todo.status != 'Not Started' %}
                     <span class="badge rounded-pill bg-secondary ms-1">{{ todo.status }}</span>
                     {% endif %}
                 </h5>

                {% if todo.description %}
                <p class="mb-1 text-body">{{ todo.description if todo.status != 'Done' else '...' }}</p> {# Keep desc shorter if done #}
                {% endif %}

                {% if todo.photo_url %}
                {# Make photo clickable? Link to original? #}
                <img src="{{ todo.photo_url }}" alt="Todo photo for {{ todo.title }}" class="img-thumbnail todo-photo mt-2" style="max-width: 80px; max-height: 80px;">
                {% endif %}

                <div class="mt-1">
                    <small class="text-body">
                         Created: {{ todo.created_at.strftime('%Y-%m-%d %H:%M') }}
                         {% if todo.due_date %}
                          | Due: <span class="fw-bold {% if today_date is defined and todo.due_date < today_date and todo.status != 'Done' %}text-danger{% endif %}">{{ todo.due_date.strftime('%Y-%m-%d') }}</span>
                         {% endif %}
                    </small>
                </div>
            </div>
            {# ------------------ #}

            {# --- Action Buttons --- #}
            <div class="d-flex align-items-center flex-shrink-0">
                {# Status Update Dropdown #}
                 <form action="{{ url_for('web_update_todo_status', todo_id=todo.id) }}" method="post" class="me-2">
                    <select name="status" class="form-select form-select-sm" onchange="this.form.submit()" aria-label="Update Status">
                         {% for status_opt in status_options %}
                         <option value="{{ status_opt }}" {% if todo.status == status_opt %}selected{% endif %}>{{ status_opt }}</option>
                         {% endfor %}
                    </select>
                    <noscript><button type="submit" class="btn btn-sm btn-outline-secondary mt-1">Update Status</button></noscript>
                </form>

                 {# Edit Button #}
                <a href="{{ url_for('web_edit_todo_form', todo_id=todo.id) }}" class="btn btn-outline-primary btn-sm me-2">Edit</a>

                {# Delete Button #}
                 <form action="{{ url_for('web_delete_todo', todo_id=todo.id) }}" method="post" onsubmit="return confirm('Are you sure you want to delete this item: \'{{ todo.title|escape }}\'?');">
                    <button type="submit" class="btn btn-outline-danger btn-sm">Delete</button>
                </form>
            </div>
            {# -------------------- #}
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p>You have no todos matching the current filters. Try adding one or clearing the filters!</p>
    {% endif %}
    {# ------------------------ #}

</div>
{% endblock %}

{% block scripts %}
{# The problematic line trying to access Python modules is removed. #}
{# 'today_date' is now passed directly from the Python route handler. #}

{# You might add JavaScript here for better UX later, e.g., date pickers, live filtering #}
<script>






</script>
{% endblock %}